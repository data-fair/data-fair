<template>
  <v-row class="ma-0">
    <v-btn
      v-if="!createToggle"
      color="primary"
      class="mb-3"
      @click="createToggle = true"
    >
      {{ t('addApiKey') }}
    </v-btn>
    <v-slide-y-transition v-if="createToggle">
      <v-card
        :title="t('addNewApiKey')"
      >
        <v-card-text>
          <v-form v-model="newApiKeyValid">
            <v-text-field
              v-model="newApiKey.title"
              :rules="[v => !!v || '']"
              :label="t('title')"
              required
            />
            <v-checkbox
              v-if="session.state.user.adminMode"
              v-model="newApiKey.adminMode"
              :label="t('superadminKey')"
              class="text-warning"
              density="comfortable"
              hide-details
            />
            <v-checkbox
              v-if="session.state.user.adminMode && newApiKey.adminMode"
              v-model="newApiKey.asAccount"
              :label="t('asAccountKey')"
              class="text-warning"
              density="comfortable"
              hide-details
            />
            <tutorial-alert
              id="api-key-scope"
              :text="t('scopeMsg')"
              persistent
              initial
            />
            <v-select
              v-if="filteredScopes.length > 1"
              v-model="newApiKey.scopes"
              :label="t('scope')"
              :items="filteredScopes"
              :item-title="t"
              multiple
              density="comfortable"
            />
          </v-form>
        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <v-btn
            @click="createToggle = false"
          >
            {{ t('cancel') }}
          </v-btn>
          <v-btn
            color="primary"
            variant="elevated"
            :disabled="!newApiKeyValid"
            @click="addApiKey"
          >
            {{ t('add') }}
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-slide-y-transition>
  </v-row>

  <v-row>
    <v-col
      v-for="(apiKey, rowIndex) in settings.apiKeys"
      :key="rowIndex"
      lg="4"
      md="6"
      sm="12"
    >
      <v-card
        variant="outlined"
        tile
      >
        <v-card-title class="d-flex justify-space-between align-center">
          <h4 class="text-h6">
            {{ apiKey.title }}
          </h4>
          <settings-api-key-use-menu :api-key="apiKey" />
        </v-card-title>
        <v-card-text>
          <v-alert
            v-if="!!apiKey.clearKey"
            type="warning"
            class="mb-2"
            :text="t('newKeyAlert')"
          />
          <v-alert
            v-if="!!apiKey.adminMode"
            type="warning"
            class="mb-2"
            :text="t('superadminKeyAlert')"
          />
          <v-alert
            v-if="!!apiKey.asAccount"
            type="warning"
            class="mb-2"
            :text="t('asAccountKeyAlert')"
          />
          <p
            v-if="!!apiKey.clearKey"
            class="mb-4"
          >
            {{ t('secretKey') }} : <strong>{{ apiKey.clearKey }}</strong>
          </p>
          <p
            v-if="apiKey.scopes?.length"
            class="mb-4"
          >
            {{ t('scope') }} : {{ apiKey.scopes?.map(s => t(s)).join(', ') }}
          </p>
          <tutorial-alert
            id="api-key-email"
            :text="t('emailMsg')"
            persistent
            :initial="false"
          />
          <p
            v-if="apiKey.email"
            class="mb-4"
          >
            {{ t('email') }} : {{ apiKey.email }}
          </p>
        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <confirm-menu
            yes-color="warning"
            :tooltip="t('deleteKey')"
            :text="t('deleteKeyDetails')"
            @confirm="removeApiKey(rowIndex)"
          />
        </v-card-actions>
      </v-card>
    </v-col>
  </v-row>
</template>

<i18n lang="yaml">
fr:
  addApiKey: Ajouter une clé d'API
  addNewApiKey: Ajout d'une nouvelle clé d'API
  title: Titre
  superadminKey: Clé de type super-administrateur
  asAccountKey: Clé permettant de travailler dans le contexte d'autres comptes (nécessaire pour configurer le service de traitements périodiques)
  cancel: Annuler
  add: Ajouter
  newKeyAlert: Cette clé secrète apparait en clair car vous venez de la créer. Notez là, elle ne sera pas lisible par la suite.
  superadminKeyAlert: Cette clé est de type super-administrateur
  asAccountKeyAlert: Cette clé permet de travailler dans le contexte d'autres comptes
  secretKey: Clé secrète
  scope: Portée
  scopeMsg: Si vous donnez une portée à cette clé d'API elle pourra servir à effectuer toutes les opérations correspondantes sur toutes les ressources pour lesquelles les administrateurs de ce compte ont la permission requise. Si vous ne donnez aucune portée les seules permissions appliquées seront celles affectées explicitement à la pseudo adresse mail de la clé.
  email: Email
  emailMsg: Ce pseudo email peut être utilisé pour affecter des permissions fines à cette clé d'API.
  deleteKey: Supprimer cette clé d'API
  deleteKeyDetails: Voulez vous vraiment supprimer cette clé d'API ? Si des programmes l'utilisent ils cesseront de fonctionner.
  datasets: Jeux de données - toutes opérations
  datasets-read: Jeux de données - lecture
  datasets-write: Jeux de données - écriture
  datasets-admin: Jeux de données - administration
  applications: Applications
  catalogs: Connecteurs aux catalogues
  stats: Récupération d'informations statistiques
en:
  addApiKey: Add an API key
  addNewApiKey: Add a new API key
  title: Title
  superadminKey: Super-admin key type
  asAccountKey: Key to work in the context of other accounts (required to configure periodic processings service)
  cancel: Cancel
  add: Add
  newKeyAlert: You can view this key because you just created it. Store it in a secure place, it won't be readable again on this platform.
  superadminKeyAlert: Super-admin key type
  asAccountKeyAlert: Key to work in the context of other accounts
  secretKey: Secret key
  scope: Scope
  scopeMsg: If you give a scope to this API key it will be able to perform all corresponding operations on all resources for which the account administrators have the required permissions. If you don't give any scope the only permissions applied will be those explicitly assigned to the key's pseudo email address.
  email: Email
  emailMsg: This pseudo email address can be used to assign fine-grained permissions to this API key.
  deleteKey: Delete this API key
  deleteKeyDetails: Do you really want to delete this API key ? Softwares or scripts that use this key won't work anymore.
  datasets: Datasets - all operations
  datasets-read: Datasets - read
  datasets-write: Datasets - write
  datasets-admin: Datasets - admin
  applications: Applications
  catalogs: Catalogs
  stats: Stats
</i18n>

<script lang="ts" setup>
import type { Settings } from '#api/types'

const { settings, restrictedScopes } = defineProps<{
  settings: Settings
  restrictedScopes?: string[]
}>()

const emit = defineEmits<{
  (event: 'updated', settings: Settings): void
}>()
const { t } = useI18n()
const session = useSessionAuthenticated()

const newApiKey = ref<{
  title: string
  scopes: string[]
  adminMode?: boolean
  asAccount?: boolean
}>({
  title: '',
  scopes: []
})

const newApiKeyValid = ref(false)
const createToggle = ref(false)

const filteredScopes = computed(() => {
  if (!restrictedScopes || restrictedScopes.length === 0) return scopes
  return scopes.filter(s => restrictedScopes.includes(s))
})

onMounted(() => {
  if (filteredScopes.value.length === 1) {
    newApiKey.value.scopes.push(filteredScopes.value[0])
  }
})

const addApiKey = () => {
  const updatedSettings = { ...settings }
  updatedSettings.apiKeys?.push(newApiKey.value)
  createToggle.value = false
  newApiKey.value = {
    title: '',
    scopes: []
  }
  emit('updated', updatedSettings)
}

const removeApiKey = (rowIndex: number) => {
  const updatedSettings = { ...settings }
  updatedSettings.apiKeys?.splice(rowIndex, 1)
  emit('updated', updatedSettings)
}

const scopes = [
  'datasets',
  'datasets-read',
  'datasets-write',
  'datasets-admin',
  'applications',
  'stats'
]

</script>
