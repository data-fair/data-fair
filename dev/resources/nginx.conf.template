# nginx configuration file for Data Fair development and test environment

# nginx cache definition
proxy_cache_path /var/cache/nginx/data-fair levels=1:2 keys_zone=data-fair-cache:10m inactive=10d max_size=10g;
# this is necessary for host based routing where different hosts serve different content on the same path
proxy_cache_key $scheme$host$request_uri;

server {
  listen ${NGINX_PORT1};
  server_name _;

  # Transmit host, protocol and user ip, we use it for routing, rate limiting, etc.
  proxy_set_header Host $http_host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $http_host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Client-IP $remote_addr;

  # Headers we use for better private caching
  proxy_set_header X-Private-If-Modified-Since $http_if_modified_since;
  proxy_set_header X-Private-If-None-Match $http_if_none_match;
  proxy_pass_header "X-Accel-Buffering";
  # web socket support
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "Upgrade";
  # range requests support
  proxy_set_header Range $http_range;
  # accept some occasional long queries
  proxy_read_timeout 600s;
  # body size limits are implemented by services themselves
  client_max_body_size 0;
  # direct streaming of uploads
  proxy_request_buffering off;
  # direct streaming of downloads, enabled on-demand by services using x-accel-buffering header
  proxy_buffering off;
  # allow large response headers (setCookies with large session token)
  proxy_buffer_size 32k;
  proxy_buffers 4 32k;

  # a simple cache respecting the cache-control headers
  proxy_cache data-fair-cache;
  proxy_cache_revalidate on;
  proxy_cache_lock on;
  proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
  proxy_cache_convert_head off;
  add_header X-Cache-Status $upstream_cache_status;
  proxy_cache_bypass $http_x_cache_bypass;
  proxy_cache_bypass $cookie_cache_bypass;
  
  # redirect root to /data-fair/
  location = / {  
    return 302 /data-fair/;
  }
  location = /data-fair/embed {  
    return 302 /data-fair/embed/dev;
  }
  location = /data-fair/embed/ {  
    return 302 /data-fair/embed/dev;
  }

  location ~ /data-fair/embed/(.*)-ui-config.js {
    proxy_pass http://localhost:${DEV_API_PORT};
  }
  # comment this to test built UI served by api
  location /data-fair/embed {
    proxy_pass http://localhost:${DEV_UI_PORT};
  }

  location /data-fair {
    rewrite  ^/data-fair/(.*) /$1 break;
    proxy_pass http://localhost:${DEV_API_PORT}/;
  }

  location /simple-directory {
    proxy_pass http://localhost:${SD_PORT};
  }
  
  location /openapi-viewer {
    proxy_pass http://localhost:${OAV_PORT};
  }

  location /capture {
    rewrite  ^/capture/(.*) /$1 break;
    proxy_pass http://localhost:8087/;
  }

  location /events {
    proxy_pass http://localhost:${EVENTS_PORT};
  }

  location /catalogs {
    proxy_pass http://localhost:${CATALOGS_PORT};
  }
}

# secondary exposition to simulate a publication site
server {
  listen ${NGINX_PORT2};
  server_name _;

  # Transmit host, protocol and user ip, we use it for routing, rate limiting, etc.
  proxy_set_header Host $http_host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $http_host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Client-IP $remote_addr;
  # Headers we use for better private caching
  proxy_set_header X-Private-If-Modified-Since $http_if_modified_since;
  proxy_set_header X-Private-If-None-Match $http_if_none_match;
  proxy_pass_header "X-Accel-Buffering";
  # web socket support
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "Upgrade";
  # accept some occasional long queries
  proxy_read_timeout 600s;
  # body size limits are implemented by services themselves
  client_max_body_size 0;
  # direct streaming of uploads
  proxy_request_buffering off;
  # direct streaming of downloads, enabled on-demand by services using x-accel-buffering header
  proxy_buffering off;
  # allow large response headers (setCookies with large session token)
  proxy_buffer_size 32k;
  proxy_buffers 4 32k;

  # a simple cache respecting the cache-control headers
  proxy_cache data-fair-cache;
  proxy_cache_revalidate on;
  proxy_cache_lock on;
  proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
  proxy_cache_convert_head off;
  add_header X-Cache-Status $upstream_cache_status;
  proxy_cache_bypass $http_x_cache_bypass;
  proxy_cache_bypass $cookie_cache_bypass;
  
  # redirect root to /data-fair/
  location = / {  
    return 302 /data-fair/;
  }

  location /data-fair {
    rewrite  ^/data-fair/(.*) /$1 break;
    proxy_pass http://localhost:${DEV_API_PORT}/;
  }

  location /simple-directory {
    rewrite  ^/simple-directory/(.*) /$1 break;
    proxy_pass http://localhost:${SD_PORT}/;
  }
  
  location /api-doc {
    rewrite  ^/api-doc/(.*) /$1 break;
    proxy_pass http://localhost:${OAV_PORT}/;
  }

  location /capture {
    rewrite  ^/capture/(.*) /$1 break;
    proxy_pass http://localhost:${CAPTURE_PORT}/;
  }

  location /events {
    rewrite  ^/events/(.*) /$1 break;
    proxy_pass http://localhost:${EVENTS_PORT}/;
  }
}